<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azan Times & Islamic Calendar</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icons/prayer.png">
    <link rel="shortcut icon" type="image/png" href="icons/prayer.png">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .prayer-times {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .prayer-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .prayer-card.optional {
            background: #f8f9fa;
            border: 2px dashed #e9ecef;
        }

        .prayer-card.optional h3 {
            color: #6c757d;
        }

        .prayer-card.active {
            background: #e3f2fd;
        }

        .prayer-card h3 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        .prayer-card .countdown {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .location-info {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .moon-phase {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .moon-calendar-container {
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .moon-calendar-header {
            text-align: center;
            margin-bottom: 15px;
            color: #2196F3;
            font-weight: 500;
        }

        .moon-calendar {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .moon-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
        }

        .moon-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .date-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
            padding-top: 5px;
        }

        .moon-day {
            flex: 1;
            min-width: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .moon-day.current .date {
            color: #2196F3;
            font-weight: 500;
        }

        .moon-day .moon-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #111;
            position: relative;
            overflow: hidden;
            box-shadow: inset -3px 0 5px rgba(0,0,0,0.4);
        }

        .moon-day .moon-icon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #FFD700;
            transform-origin: right center;
            transition: transform 0.3s ease;
        }

        .moon-day.current .moon-icon {
            box-shadow: 0 0 0 2px #2196F3;
        }

        .moon-day .date {
            font-size: 0.75em;
            color: #666;
            text-align: center;
        }

        .moon-phase-current {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .moon-phase-current .moon-icon-large {
            width: 100px;
            height: 100px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .moon-phase-info {
            text-align: left;
        }

        .moon-phase-info h3 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        .moon-phase-info p {
            color: #666;
            margin: 5px 0;
        }

        .islamic-date {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        .material-icons {
            vertical-align: middle;
            margin-right: 5px;
        }

        #moonPhaseImg {
            width: 100px;
            height: 100px;
            margin: 20px auto;
        }

        .notification-banner {
            background: #2196F3;
            color: white;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            display: none;
        }

        .notification-banner.show {
            display: block;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #2196F3;
            transition: width 1s linear;
        }

        .qari-selector {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .qari-selector select {
            padding: 8px 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1em;
            margin-top: 10px;
            background: #fff;
            cursor: pointer;
        }

        .qari-selector select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .test-azan-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .test-azan-btn:hover {
            background: #1976D2;
        }

        .calculation-method {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .calculation-method select {
            padding: 8px 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1em;
            margin-top: 10px;
            background: #fff;
            cursor: pointer;
            width: 200px;
        }

        .calculation-method select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .method-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            display: none;
        }

        .method-info.show {
            display: block;
        }

        .madhab-selector {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .madhab-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .madhab-option input[type="radio"] {
            margin-right: 5px;
        }

        .prayer-muazzin-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .prayer-muazzin {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .prayer-muazzin h3 {
            color: #2196F3;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .qari-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .test-azan-btn {
            padding: 5px 15px;
            font-size: 0.9em;
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 1rem;
            margin: 1rem;
            border-radius: 4px;
            border: 1px solid #fcc;
        }

        .dst-settings {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .dst-info {
            margin-bottom: 20px;
        }

        .dst-options {
            margin-bottom: 20px;
        }

        .dst-option {
            margin-bottom: 10px;
        }

        .dst-explanation {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="notification-banner" id="notificationBanner">
        Click here to enable Azan notifications
    </div>

    <div class="container">
        <div class="header">
            <h1>Azan Times & Islamic Calendar</h1>
            <p id="currentTime"></p>
        </div>

        <div class="calculation-method">
            <h2><span class="material-icons">calculate</span> Prayer Time Calculation Method</h2>
            <div style="margin-top: 15px;">
                <select id="calculationMethodSelect">
                    <option value="MuslimWorldLeague">Muslim World League</option>
                    <option value="Egyptian">Egyptian General Authority</option>
                    <option value="ISNA">Islamic Society of North America (ISNA)</option>
                    <option value="MWL">Muslim World League (Europe)</option>
                    <option value="Makkah">Umm Al-Qura, Makkah</option>
                    <option value="Karachi">University of Islamic Sciences, Karachi</option>
                    <option value="Tehran">Institute of Geophysics, Tehran</option>
                    <option value="Custom">Custom Settings</option>
                </select>
                <div id="methodInfo" class="method-info"></div>
                <div class="madhab-selector">
                    <label class="madhab-option">
                        <input type="radio" name="madhab" value="Shafi" checked> Shafi'i
                    </label>
                    <label class="madhab-option">
                        <input type="radio" name="madhab" value="Hanafi"> Hanafi
                    </label>
                </div>
            </div>
        </div>

        <!-- DST Settings Section -->
        <div class="dst-settings">
            <h2><span class="material-icons">access_time</span> Daylight Saving Time Settings</h2>
            <div class="dst-info">
                <p>Current status: <span id="dstStatus">Detecting...</span></p>
                <p>Time zone: <span id="timeZoneInfo">Detecting...</span></p>
            </div>
            <div class="dst-options">
                <div class="dst-option">
                    <label>
                        <input type="radio" name="dstHandling" value="auto" checked> 
                        Automatic (Use system settings)
                    </label>
                </div>
                <div class="dst-option">
                    <label>
                        <input type="radio" name="dstHandling" value="always"> 
                        Always use DST
                    </label>
                </div>
                <div class="dst-option">
                    <label>
                        <input type="radio" name="dstHandling" value="never"> 
                        Never use DST
                    </label>
                </div>
                <div class="dst-option">
                    <label>
                        <input type="radio" name="dstHandling" value="custom"> 
                        Custom adjustment:
                    </label>
                    <select id="customDstAdjustment" disabled>
                        <option value="-2">-2 hours</option>
                        <option value="-1">-1 hour</option>
                        <option value="0" selected>No adjustment</option>
                        <option value="1">+1 hour</option>
                        <option value="2">+2 hours</option>
                    </select>
                </div>
            </div>
            <div class="dst-explanation">
                <p>Daylight Saving Time can affect prayer calculations. Choose how you want to handle DST adjustments.</p>
            </div>
        </div>

        <div class="qari-selector">
            <h2><span class="material-icons">record_voice_over</span> Muazzin Selection</h2>
            <div class="prayer-muazzin-container">
                <div class="prayer-muazzin">
                    <h3>Fajr Adhan</h3>
                    <select id="fajrQariSelect" class="qari-select"></select>
                    <select id="fajrNotifType" class="notif-select">
                        <option value="adhan">Adhan</option>
                        <option value="beep">Beep</option>
                    </select>
                    <button class="test-azan-btn" onclick="testAzan('fajr')">Test</button>
                </div>
                <div class="prayer-muazzin">
                    <h3>Dhuhr Adhan</h3>
                    <select id="dhuhrQariSelect" class="qari-select"></select>
                    <select id="dhuhrNotifType" class="notif-select">
                        <option value="adhan">Adhan</option>
                        <option value="beep">Beep</option>
                    </select>
                    <button class="test-azan-btn" onclick="testAzan('dhuhr')">Test</button>
                </div>
                <div class="prayer-muazzin">
                    <h3>Asr Adhan</h3>
                    <select id="asrQariSelect" class="qari-select"></select>
                    <select id="asrNotifType" class="notif-select">
                        <option value="adhan">Adhan</option>
                        <option value="beep">Beep</option>
                    </select>
                    <button class="test-azan-btn" onclick="testAzan('asr')">Test</button>
                </div>
                <div class="prayer-muazzin">
                    <h3>Maghrib Adhan</h3>
                    <select id="maghribQariSelect" class="qari-select"></select>
                    <select id="maghribNotifType" class="notif-select">
                        <option value="adhan">Adhan</option>
                        <option value="beep">Beep</option>
                    </select>
                    <button class="test-azan-btn" onclick="testAzan('maghrib')">Test</button>
                </div>
                <div class="prayer-muazzin">
                    <h3>Isha Adhan</h3>
                    <select id="ishaQariSelect" class="qari-select"></select>
                    <select id="ishaNotifType" class="notif-select">
                        <option value="adhan">Adhan</option>
                        <option value="beep">Beep</option>
                    </select>
                    <button class="test-azan-btn" onclick="testAzan('isha')">Test</button>
                </div>
            </div>
        </div>

        <div class="location-info">
            <h2><span class="material-icons">location_on</span> Location Information</h2>
            <p id="locationDetails">Detecting location...</p>
        </div>

        <div class="prayer-times">
            <div class="prayer-card optional" id="tahajjudCard">
                <h3>Tahajjud</h3>
                <p id="tahajjudTime">--:--</p>
                <p class="countdown" id="tahajjudCountdown"></p>
                <div class="progress-bar" id="tahajjudProgress"></div>
            </div>
            <div class="prayer-card optional" id="suhoorCard">
                <h3>Suhoor Ends</h3>
                <p id="suhoorTime">--:--</p>
                <p class="countdown" id="suhoorCountdown"></p>
                <div class="progress-bar" id="suhoorProgress"></div>
            </div>
            <div class="prayer-card" id="fajrCard">
                <h3>Fajr</h3>
                <p id="fajrTime">--:--</p>
                <p class="countdown" id="fajrCountdown"></p>
                <div class="progress-bar" id="fajrProgress"></div>
            </div>
            <div class="prayer-card optional" id="ishraqCard">
                <h3>Ishraq</h3>
                <p id="ishraqTime">--:--</p>
                <p class="countdown" id="ishraqCountdown"></p>
                <div class="progress-bar" id="ishraqProgress"></div>
            </div>
            <div class="prayer-card" id="dhuhrCard">
                <h3>Dhuhr</h3>
                <p id="dhuhrTime">--:--</p>
                <p class="countdown" id="dhuhrCountdown"></p>
                <div class="progress-bar" id="dhuhrProgress"></div>
            </div>
            <div class="prayer-card" id="asrCard">
                <h3>Asr</h3>
                <p id="asrTime">--:--</p>
                <p class="countdown" id="asrCountdown"></p>
                <div class="progress-bar" id="asrProgress"></div>
            </div>
            <div class="prayer-card" id="maghribCard">
                <h3>Maghrib</h3>
                <p id="maghribTime">--:--</p>
                <p class="countdown" id="maghribCountdown"></p>
                <div class="progress-bar" id="maghribProgress"></div>
            </div>
            <div class="prayer-card" id="ishaCard">
                <h3>Isha</h3>
                <p id="ishaTime">--:--</p>
                <p class="countdown" id="ishaCountdown"></p>
                <div class="progress-bar" id="ishaProgress"></div>
            </div>
        </div>

        <div class="moon-phase">
            <h2><span class="material-icons">brightness_2</span> Moon Phase</h2>
            
            <div class="moon-phase-current">
                <div class="moon-icon-large" id="currentMoonIcon"></div>
                <div class="moon-phase-info">
                    <h3 id="moonPhaseText">Loading moon phase...</h3>
                    <p id="moonPhaseDate"></p>
                    <p id="moonPhaseDetails"></p>
                </div>
            </div>

            <div class="moon-calendar-container">
                <div class="moon-calendar-header">
                    <span id="calendarMonth">Loading...</span>
                </div>
                <div class="moon-calendar" id="moonCalendar">
                    <div class="moon-line" id="moonLine"></div>
                    <div class="date-line" id="dateLine"></div>
                </div>
            </div>
        </div>

        <div class="islamic-date">
            <h2><span class="material-icons">calendar_today</span> Islamic Date</h2>
            <p id="islamicDate">Loading Islamic date...</p>
        </div>
    </div>

    <!-- Scripts - Load in correct order -->
    <!-- 1. Third-party dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    
    <!-- 2. Load Adhan.js with fallback -->
    <script>
        // Load Adhan.js with fallback
        function loadAdhan() {
            return new Promise((resolve, reject) => {
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://cdn.jsdelivr.net/npm/adhan@4.4.3/dist/adhan.min.js';
                cdnScript.onerror = () => {
                    console.warn('CDN Adhan.js failed, trying local version...');
                    const localScript = document.createElement('script');
                    localScript.src = 'js/adhan.js';
                    localScript.onerror = () => {
                        const error = new Error('Failed to load Adhan.js from both CDN and local sources');
                        console.error(error);
                        reject(error);
                    };
                    localScript.onload = resolve;
                    document.body.appendChild(localScript);
                };
                cdnScript.onload = resolve;
                document.body.appendChild(cdnScript);
            });
        }

        // Load Adhan.js immediately
        loadAdhan().catch(error => {
            console.error('Error loading Adhan.js:', error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                Failed to load prayer calculation library. 
                <br>
                Please check your internet connection and refresh the page.
                <br>
                <small>Error: ${error.message}</small>
                <button onclick="this.parentElement.remove()" style="
                    position: absolute;
                    top: 0.5rem;
                    right: 0.5rem;
                    background: none;
                    border: none;
                    color: #c00;
                    font-size: 1.5rem;
                    cursor: pointer;
                    padding: 0 0.5rem;
                ">Ã—</button>
            `;
            document.body.insertBefore(errorDiv, document.body.firstChild);
        });
    </script>

    <!-- 3. Application scripts -->
    <script src="js/adhan-init.js"></script>
    <script src="azan.js"></script>
    <script src="prayer-calculation.js"></script>

    <script>
        const calculationMethodInfo = {
            MuslimWorldLeague: "Standard method used by the Muslim World League. Fajr: 18Â°, Isha: 17Â°",
            Egyptian: "Egyptian General Authority of Survey. Fajr: 19.5Â°, Isha: 17.5Â°",
            Karachi: "University of Islamic Sciences, Karachi. Fajr: 18Â°, Isha: 18Â°",
            UmmAlQura: "Umm Al-Qura University, Makkah. Fajr: 18.5Â°, Isha: 90min after Maghrib",
            Dubai: "UAE Method. Fajr: 18.2Â°, Isha: 18.2Â°",
            MoonsightingCommittee: "Moonsighting Committee. Fajr: 18Â°, Isha: 18Â°",
            NorthAmerica: "Islamic Society of North America. Fajr: 15Â°, Isha: 15Â°",
            Kuwait: "Kuwait Method. Fajr: 18Â°, Isha: 17.5Â°",
            Qatar: "Qatar Method. Fajr: 18Â°, Isha: 90min after Maghrib",
            Singapore: "Singapore Method. Fajr: 20Â°, Isha: 18Â°"
        };

        // Initialize calculation method selector
        function initializeCalculationMethod() {
            const select = document.getElementById('calculationMethodSelect');
            const madhabInputs = document.querySelectorAll('input[name="madhab"]');
            
            // Set default method if not in localStorage
            if (!localStorage.getItem('calculationMethod')) {
                localStorage.setItem('calculationMethod', 'MuslimWorldLeague');
                console.log("Set default calculation method: MuslimWorldLeague");
            }
            
            // Initialize calculation method
            const savedMethod = localStorage.getItem('calculationMethod');
            if (savedMethod && select.querySelector(`option[value="${savedMethod}"]`)) {
                select.value = savedMethod;
            } else {
                select.value = 'MuslimWorldLeague';
                localStorage.setItem('calculationMethod', 'MuslimWorldLeague');
            }
            
            updateMethodInfo(select.value);

            // Add change event listener for calculation method
            select.addEventListener('change', async (e) => {
                const selectedMethod = e.target.value;
                localStorage.setItem('calculationMethod', selectedMethod);
                currentCalculationMethod = selectedMethod;
                updateMethodInfo(selectedMethod);
                
                try {
                    await calculatePrayerTimes();
                    console.log(`Prayer times updated using ${selectedMethod} method`);
                } catch (error) {
                    console.error('Error updating prayer times:', error);
                    alert('Error calculating prayer times. Falling back to API.');
                    await fallbackToAPI();
                }
            });

            // Initialize madhab
            const savedMadhab = localStorage.getItem('madhab') || 'Shafi';
            madhabInputs.forEach(input => {
                if (input.value === savedMadhab) {
                    input.checked = true;
                }
            });

            // Add change event listener for madhab
            madhabInputs.forEach(input => {
                input.addEventListener('change', async (e) => {
                    if (e.target.checked) {
                        localStorage.setItem('madhab', e.target.value);
                        currentMadhab = e.target.value;
                        try {
                            await calculatePrayerTimes();
                            console.log(`Prayer times updated using ${e.target.value} madhab`);
                        } catch (error) {
                            console.error('Error updating prayer times:', error);
                            alert('Error calculating prayer times. Falling back to API.');
                            await fallbackToAPI();
                        }
                    }
                });
            });
        }

        function updateMethodInfo(method) {
            const infoDiv = document.getElementById('methodInfo');
            const methodData = CALCULATION_METHODS[method];
            
            if (methodData) {
                let info = `<strong>${methodData.name}</strong><br>`;
                info += `Region: ${methodData.region}<br>`;
                info += `Fajr: ${methodData.fajrAngle}Â°`;
                
                if (methodData.ishaAngle) {
                    info += `, Isha: ${methodData.ishaAngle}Â°`;
                } else if (methodData.ishaMinutes) {
                    info += `, Isha: ${methodData.ishaMinutes} min after Maghrib`;
                }
                
                if (methodData.adjustments) {
                    const adjustments = Object.entries(methodData.adjustments)
                        .filter(([_, value]) => value !== 0)
                        .map(([prayer, value]) => `${prayer}: ${value > 0 ? '+' : ''}${value} min`);
                    
                    if (adjustments.length > 0) {
                        info += `<br>Adjustments: ${adjustments.join(', ')}`;
                    }
                }
                
                infoDiv.innerHTML = info;
                infoDiv.classList.add('show');
            } else {
                infoDiv.textContent = 'Method information not available';
                infoDiv.classList.remove('show');
            }
        }

        // Get user's location
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    showPosition,
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                handleLocationError({ code: 0, message: "Geolocation is not supported" });
            }
        }

        function handleLocationError(error) {
            console.log("Using default location due to:", error);
            showPosition({
                coords: {
                    latitude: 21.4225,  // Makkah coordinates as default
                    longitude: 39.8262
                }
            });
            
            let errorMessage = "Using default location (Makkah). Error: ";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += "Location access denied.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += "Location unavailable.";
                    break;
                case error.TIMEOUT:
                    errorMessage += "Location request timed out.";
                    break;
                default:
                    errorMessage += "Unknown error occurred.";
            }
            document.getElementById('locationDetails').innerHTML = errorMessage;
        }

        async function showPosition(position) {
            try {
                latitude = position.coords.latitude;
                longitude = position.coords.longitude;
                
                document.getElementById('locationDetails').innerHTML = `Coordinates: ${latitude.toFixed(4)}, ${longitude.toFixed(4)} (Getting location name...)`;
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=en`);
                    if (!response.ok) throw new Error('Location lookup failed');
                    
                    const data = await response.json();
                    const locationName = data.display_name || 'Location name unavailable';
                    document.getElementById('locationDetails').innerHTML = locationName;
                } catch (error) {
                    console.error("Error getting location name:", error);
                    document.getElementById('locationDetails').innerHTML = `Location: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                }
                
                // Calculate prayer times after getting location
                calculatePrayerTimes();
            } catch (error) {
                console.error("Error processing position:", error);
                handleLocationError(error);
            }
        }

        async function calculatePrayerTimes() {
            try {
                if (!latitude || !longitude) {
                    throw new Error('Location coordinates not available');
                }

                // Create coordinates object
                const coordinates = new Adhan.Coordinates(latitude, longitude);
                const date = new Date();
                
                // Get calculation parameters based on method
                const params = getCalculationParameters();
                
                // Handle high latitude adjustments
                if (Math.abs(latitude) >= 45) {
                    params.highLatitudeRule = getHighLatitudeRule();
                }

                try {
                    // Calculate prayer times using Adhan.js
                    const prayerTimes = new Adhan.PrayerTimes(coordinates, date, params);
                    
                    // Format times using moment.js
                    const times = {
                        fajr: moment(prayerTimes.fajr),
                        sunrise: moment(prayerTimes.sunrise),
                        dhuhr: moment(prayerTimes.dhuhr),
                        asr: moment(prayerTimes.asr),
                        maghrib: moment(prayerTimes.maghrib),
                        isha: moment(prayerTimes.isha)
                    };

                    // Validate prayer times
                    if (!validatePrayerTimes(times)) {
                        throw new Error('Invalid prayer times calculated');
                    }

                    // Calculate optional prayer times
                    times.tahajjud = calculateTahajjudTime(times.isha, times.fajr);
                    times.suhoor = calculateSuhoorTime(times.fajr);
                    times.ishraq = calculateIshraqTime(times.sunrise);

                    // Store times for countdown
                    currentPrayerTimes = { ...times };

                    // Update UI
                    updatePrayerTimesUI(times);

                } catch (localError) {
                    console.error("Local calculation failed:", localError);
                    
                    // Fallback to Al Adhan API
                    const apiMethod = getApiMethodNumber(currentCalculationMethod);
                    const apiUrl = `https://api.aladhan.com/v1/timings/${moment().format('DD-MM-YYYY')}?latitude=${latitude}&longitude=${longitude}&method=${apiMethod}&school=${currentMadhab === 'Hanafi' ? 1 : 0}&adjustment=1`;
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.code === 200 && data.data && data.data.timings) {
                        const timings = data.data.timings;
                        
                        // Convert API times to moment objects
                        const times = {
                            fajr: moment(timings.Fajr, 'HH:mm'),
                            sunrise: moment(timings.Sunrise, 'HH:mm'),
                            dhuhr: moment(timings.Dhuhr, 'HH:mm'),
                            asr: moment(timings.Asr, 'HH:mm'),
                            maghrib: moment(timings.Maghrib, 'HH:mm'),
                            isha: moment(timings.Isha, 'HH:mm')
                        };

                        if (!validatePrayerTimes(times)) {
                            throw new Error('Invalid prayer times received from API');
                        }

                        // Calculate optional prayer times
                        times.tahajjud = calculateTahajjudTime(times.isha, times.fajr);
                        times.suhoor = calculateSuhoorTime(times.fajr);
                        times.ishraq = calculateIshraqTime(times.sunrise);

                        // Store times for countdown
                        currentPrayerTimes = { ...times };

                        // Update UI
                        updatePrayerTimesUI(times);
                    }
                }

                // Update countdowns immediately
                updateCountdowns();

            } catch (error) {
                console.error("Error calculating prayer times:", error);
                document.getElementById('locationDetails').innerHTML += `<br>Error calculating prayer times: ${error.message}. Please try refreshing the page.`;
                
                // Clear all time displays
                ['tahajjud', 'suhoor', 'fajr', 'sunrise', 'ishraq', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
                    const timeElement = document.getElementById(`${prayer}Time`);
                    if (timeElement) {
                        timeElement.textContent = '--:--';
                    }
                });
            }
        }

        function getCalculationParameters() {
            let params;
            
            switch (currentCalculationMethod) {
                case 'MuslimWorldLeague':
                    params = Adhan.CalculationMethod.MuslimWorldLeague();
                    break;
                case 'Egyptian':
                    params = Adhan.CalculationMethod.Egyptian();
                    break;
                case 'Karachi':
                    params = Adhan.CalculationMethod.Karachi();
                    break;
                case 'UmmAlQura':
                    params = Adhan.CalculationMethod.UmmAlQura();
                    break;
                case 'Dubai':
                    params = Adhan.CalculationMethod.Dubai();
                    break;
                case 'MoonsightingCommittee':
                    params = Adhan.CalculationMethod.MoonsightingCommittee();
                    break;
                case 'NorthAmerica':
                    params = Adhan.CalculationMethod.NorthAmerica();
                    break;
                case 'Kuwait':
                    params = Adhan.CalculationMethod.Kuwait();
                    break;
                case 'Qatar':
                    params = Adhan.CalculationMethod.Qatar();
                    break;
                case 'Singapore':
                    params = Adhan.CalculationMethod.Singapore();
                    break;
                default:
                    params = Adhan.CalculationMethod.MuslimWorldLeague();
            }
            
            // Set Madhab for Asr calculation
            params.madhab = currentMadhab === 'Hanafi' ? Adhan.Madhab.Hanafi : Adhan.Madhab.Shafi;
            
            return params;
        }

        function getApiMethodNumber(method) {
            const methodMap = {
                'MuslimWorldLeague': 3,
                'Egyptian': 5,
                'Karachi': 1,
                'UmmAlQura': 4,
                'Dubai': 8,
                'MoonsightingCommittee': 15,
                'NorthAmerica': 2,
                'Kuwait': 9,
                'Qatar': 10,
                'Singapore': 11
            };
            return methodMap[method] || 3; // Default to Muslim World League
        }

        function updateCountdowns() {
            if (!currentPrayerTimes || Object.keys(currentPrayerTimes).length === 0) return;

            const now = moment();
            
            // Reset active states
            document.querySelectorAll('.prayer-card').forEach(card => card.classList.remove('active'));

            // Find next prayer
            let nextPrayer = null;
            let nextPrayerTime = null;

            Object.entries(currentPrayerTimes).forEach(([prayer, time]) => {
                // Ensure we're comparing with today's date
                const prayerTime = moment(time);
                prayerTime.year(now.year());
                prayerTime.month(now.month());
                prayerTime.date(now.date());

                if (prayerTime.isAfter(now) && (!nextPrayerTime || prayerTime.isBefore(nextPrayerTime))) {
                    nextPrayer = prayer;
                    nextPrayerTime = prayerTime;
                }
            });

            // Update countdowns and progress bars
            Object.entries(currentPrayerTimes).forEach(([prayer, time]) => {
                const countdownElement = document.getElementById(`${prayer}Countdown`);
                const progressElement = document.getElementById(`${prayer}Progress`);
                const cardElement = document.getElementById(`${prayer}Card`);

                if (!countdownElement || !progressElement || !cardElement) return;

                // Ensure we're comparing with today's date
                const prayerTime = moment(time);
                prayerTime.year(now.year());
                prayerTime.month(now.month());
                prayerTime.date(now.date());

                if (prayer === nextPrayer) {
                    cardElement.classList.add('active');
                    const duration = moment.duration(prayerTime.diff(now));
                    const hours = Math.floor(duration.asHours());
                    const minutes = duration.minutes();
                    countdownElement.innerHTML = `Next in ${hours}h ${minutes}m`;
                    
                    // Calculate progress
                    const prevPrayerTime = getPreviousPrayerTime(prayer, currentPrayerTimes);
                    if (prevPrayerTime) {
                        const totalDuration = prayerTime.diff(prevPrayerTime);
                        const elapsed = now.diff(prevPrayerTime);
                        const progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                        progressElement.style.width = `${progress}%`;
                    }
                } else {
                    countdownElement.innerHTML = '';
                    progressElement.style.width = '0%';
                }
            });
        }

        function getPreviousPrayerTime(currentPrayer, prayers) {
            const prayerOrder = ['tahajjud', 'suhoor', 'fajr', 'ishraq', 'dhuhr', 'asr', 'maghrib', 'isha'];
            const currentIndex = prayerOrder.indexOf(currentPrayer);
            if (currentIndex <= 0) return null;
            return prayers[prayerOrder[currentIndex - 1]];
        }

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').innerHTML = moment(now).format('MMMM Do YYYY, h:mm:ss A');
        }

        async function getMoonPhase() {
            try {
                const date = new Date();
                const formattedDate = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                
                // Get moon information from Al Adhan API
                const response = await fetch(`https://api.aladhan.com/v1/gToH/${formattedDate}`);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    const hijri = data.data.hijri;
                    const islamicDay = parseInt(hijri.day);
                    const age = (islamicDay - 1) * (29.530588853 / 30); // More accurate moon age calculation
                    
                    // Calculate illumination
                    const illumination = getMoonIllumination(age);
                    const phase = getMoonPhaseFromAge(age);
                    
                    // Update UI
                    document.getElementById('moonPhaseText').innerHTML = phase;
                    document.getElementById('moonPhaseDate').innerHTML = moment(date).format('MMMM Do YYYY');
                    document.getElementById('moonPhaseDetails').innerHTML = `
                        <p>Illumination: ${Math.round(illumination * 100)}%</p>
                        <p>Islamic Date: ${hijri.day} ${hijri.month.en} ${hijri.year}</p>
                        <p>Moon Age: ${Math.round(age * 10) / 10} days</p>
                    `;
                    document.getElementById('currentMoonIcon').textContent = getMoonPhaseIcon(age);
                    
                    // Update moon calendar
                    updateMoonCalendar(date, hijri);
                } else {
                    throw new Error('Failed to fetch moon data');
                }
            } catch (error) {
                console.error('Error getting moon phase:', error);
                // Fallback to basic calculation
                const date = new Date();
                const age = moonAge(date);
                const phase = getMoonPhaseFromAge(age);
                const illumination = getMoonIllumination(age);
                
                document.getElementById('moonPhaseText').innerHTML = phase;
                document.getElementById('moonPhaseDate').innerHTML = moment(date).format('MMMM Do YYYY');
                document.getElementById('moonPhaseDetails').innerHTML = `Illumination: ${Math.round(illumination * 100)}%`;
                document.getElementById('currentMoonIcon').textContent = getMoonPhaseIcon(age);
                
                updateMoonCalendar(date);
            }
        }

        function getMoonPhaseIcon(age) {
            const phase = (age / 29.530588853) * Math.PI * 2;
            const illumination = (1 - Math.cos(phase)) / 2;

            // Return moon phase emoji based on illumination
            if (illumination < 0.1) return "ðŸŒ‘"; // New Moon
            else if (illumination < 0.4) return "ðŸŒ’"; // Waxing Crescent
            else if (illumination < 0.6) return "ðŸŒ“"; // First Quarter
            else if (illumination < 0.9) return "ðŸŒ”"; // Waxing Gibbous
            else return "ðŸŒ•"; // Full Moon
        }

        function getMoonIllumination(age) {
            // More accurate illumination calculation
            const normalizedAge = age % 29.530588853;
            const phase = (normalizedAge / 29.530588853) * Math.PI * 2;
            return (1 - Math.cos(phase)) / 2;
        }

        function updateMoonCalendar(currentDate, hijriData = null) {
            const moonLine = document.getElementById('moonLine');
            const dateLine = document.getElementById('dateLine');
            const calendarMonth = document.getElementById('calendarMonth');
            
            // Clear previous content
            moonLine.innerHTML = '';
            dateLine.innerHTML = '';
            
            // Set month name
            calendarMonth.textContent = moment(currentDate).format('MMMM YYYY');

            // Get start of current month
            const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

            // Create calendar days
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDate = new Date(startDate.getFullYear(), startDate.getMonth(), i);
                
                // Calculate moon age and illumination
                let age;
                if (hijriData && hijriData.month) {
                    // Use Hijri data if available
                    const dayInLunarMonth = ((i + parseInt(hijriData.day) - currentDate.getDate() - 1) % 30) + 1;
                    age = (dayInLunarMonth - 1) * (29.530588853 / 30);
                } else {
                    age = moonAge(dayDate);
                }
                
                const illumination = getMoonIllumination(age);
                
                // Create moon element
                const moonElement = document.createElement('div');
                moonElement.className = 'moon-day';
                if (i === currentDate.getDate()) {
                    moonElement.classList.add('current');
                }

                // Calculate the transform for the moon illumination
                const transform = illumination <= 0.5 
                    ? `scaleX(${illumination * 2})` 
                    : `scaleX(${(1 - illumination) * 2})`;
                
                const moonStyle = illumination <= 0.5
                    ? `transform: ${transform}; background: #FFD700;`
                    : `transform: ${transform}; background: #111;`;

                moonElement.innerHTML = `
                    <div class="moon-icon">
                        <div style="${moonStyle}"></div>
                    </div>
                `;
                
                const phase = getMoonPhaseFromAge(age);
                moonElement.title = `Day ${i}: ${Math.round(illumination * 100)}% illuminated\n${phase}`;
                moonLine.appendChild(moonElement);

                // Create date element
                const dateElement = document.createElement('div');
                dateElement.className = 'moon-day';
                if (i === currentDate.getDate()) {
                    dateElement.classList.add('current');
                }
                dateElement.innerHTML = `<span class="date">${i}</span>`;
                dateLine.appendChild(dateElement);
            }
        }

        function moonAge(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            const lp = 2551443;
            const now = new Date(year, month-1, day, 20, 35, 0);
            const new_moon = new Date(1970, 0, 7, 20, 35, 0);
            const phase = ((now.getTime() - new_moon.getTime())/1000) % lp;
            return phase / (24*3600) * 29.530588853;
        }

        function getMoonPhaseFromAge(age) {
            // More precise phase calculations
            const normalizedAge = age % 29.530588853;
            
            if (normalizedAge < 1.84566) return "New Moon";
            else if (normalizedAge < 5.53699) return "Waxing Crescent";
            else if (normalizedAge < 9.22831) return "First Quarter";
            else if (normalizedAge < 12.91963) return "Waxing Gibbous";
            else if (normalizedAge < 16.61096) return "Full Moon";
            else if (normalizedAge < 20.30228) return "Waning Gibbous";
            else if (normalizedAge < 23.99361) return "Last Quarter";
            else if (normalizedAge < 27.68493) return "Waning Crescent";
            return "New Moon";
        }

        async function getIslamicDate() {
            try {
                // Get Gregorian date
                const date = new Date();
                
                // Get Islamic date components
                const options = { 
                    calendar: 'islamic-umalqura',
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    numberingSystem: 'latn'
                };
                
                // Get basic Islamic date
                const islamicDate = date.toLocaleDateString('ar-SA-u-ca-islamic', options);
                
                // Get additional details from Al Adhan API
                const response = await fetch(`https://api.aladhan.com/v1/gToH?date=${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    const hijri = data.data.hijri;
                    const html = `
                        <p style="font-size: 1.2em; margin-bottom: 10px">${islamicDate}</p>
                        <p style="color: #666; font-size: 0.9em">
                            ${hijri.day} ${hijri.month.en} ${hijri.year} AH<br>
                            ${hijri.designation.abbreviated}
                        </p>
                        <p style="color: #2196F3; font-size: 0.8em; margin-top: 10px">
                            ${hijri.month.en}: ${hijri.month.meaning || ''}
                        </p>
                    `;
                    document.getElementById('islamicDate').innerHTML = html;
                } else {
                    // Fallback to basic display if API fails
                    document.getElementById('islamicDate').innerHTML = islamicDate;
                }
            } catch (error) {
                console.error('Error getting Islamic date:', error);
                // Fallback to basic Islamic date
                const basicDate = new Date().toLocaleDateString('en-US-u-ca-islamic', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('islamicDate').innerHTML = basicDate;
            }
        }

        // Show notification banner if needed
        if (Notification.permission !== "granted") {
            document.getElementById('notificationBanner').classList.add('show');
        }

        // Handle notification permission request
        document.getElementById('notificationBanner').addEventListener('click', () => {
            window.AzanPlayer.requestNotificationPermission();
            document.getElementById('notificationBanner').classList.remove('show');
        });

        // Initialize Qari selector with verified Qaris
        function initializeQariSelector() {
            const prayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
            const localAdhans = [
                { id: 'local-makkah', name: 'Makkah Adhan' },
                { id: 'local-madina', name: 'Madina Adhan' },
                { id: 'local-aqsa', name: 'Al-Aqsa Adhan' },
                { id: 'local-mishary', name: 'Mishary Rashid' },
                { id: 'local-abdul-basit', name: 'Abdul Basit' }
            ];

            prayers.forEach(prayer => {
                const select = document.getElementById(`${prayer}QariSelect`);
                if (!select) return;

                // Clear existing options
                select.innerHTML = '';
                
                // Add local Adhan options
                localAdhans.forEach(adhan => {
                    const option = document.createElement('option');
                    option.value = adhan.id;
                    option.textContent = adhan.name;
                    select.appendChild(option);
                });

                // Set saved selection or default
                const savedQari = localStorage.getItem(`${prayer}Qari`) || 'local-makkah';
                select.value = savedQari;

                // Add change event listener
                select.addEventListener('change', (e) => {
                    localStorage.setItem(`${prayer}Qari`, e.target.value);
                });
            });
        }

        // Function to test Azan
        async function testAzan(prayer) {
            const select = document.getElementById(`${prayer}QariSelect`);
            const testButton = select.nextElementSibling;
            const selectedQari = select.value;

            // Disable button and show loading state
            testButton.textContent = 'Loading...';
            testButton.disabled = true;

            try {
                // Use the AzanPlayer to handle the playback
                await window.AzanPlayer.playAdhan(prayer);
                
                // Reset button after successful playback
                testButton.textContent = 'Test';
                testButton.disabled = false;
            } catch (error) {
                console.error('Error testing Adhan:', error);
                testButton.textContent = 'Test';
                testButton.disabled = false;
            }
        }

        function getHighLatitudeRule() {
            const latitude = Math.abs(window.latitude);
            
            // For extreme latitudes (above 65Â°), use SeventhOfTheNight
            if (latitude >= 65) {
                return Adhan.HighLatitudeRule.SeventhOfTheNight;
            }
            // For high latitudes (48-65Â°), use TwilightAngle
            else if (latitude >= 48) {
                return Adhan.HighLatitudeRule.TwilightAngle;
            }
            // For moderately high latitudes (45-48Â°), use MiddleOfTheNight
            else if (latitude >= 45) {
                return Adhan.HighLatitudeRule.MiddleOfTheNight;
            }
            // For normal latitudes, no adjustment needed
            return null;
        }

        function validatePrayerTimes(times) {
            const prayers = ['fajr', 'sunrise', 'dhuhr', 'asr', 'maghrib', 'isha'];
            
            // Check if all prayer times exist and are valid moment objects
            for (const prayer of prayers) {
                if (!times[prayer] || !times[prayer].isValid()) {
                    console.error(`Invalid time for ${prayer}`);
                    return false;
                }
            }

            // Check if prayer times are in correct order
            let previousTime = times[prayers[0]];
            for (let i = 1; i < prayers.length; i++) {
                const currentTime = times[prayers[i]];
                if (!currentTime.isAfter(previousTime)) {
                    console.error(`Invalid prayer order: ${prayers[i]} is not after ${prayers[i-1]}`);
                    return false;
                }
                previousTime = currentTime;
            }

            // Additional validation for high latitudes
            if (Math.abs(window.latitude) >= 45) {
                // Check for reasonable time differences
                const fajrDhuhr = moment.duration(times.dhuhr.diff(times.fajr)).asHours();
                const dhuhrMaghrib = moment.duration(times.maghrib.diff(times.dhuhr)).asHours();
                const maghribIsha = moment.duration(times.isha.diff(times.maghrib)).asHours();

                if (fajrDhuhr < 1 || fajrDhuhr > 18 || 
                    dhuhrMaghrib < 1 || dhuhrMaghrib > 12 ||
                    maghribIsha < 0.5 || maghribIsha > 6) {
                    console.error('Invalid time differences for high latitude');
                    return false;
                }
            }

            return true;
        }

        function calculateTahajjudTime(isha, fajr) {
            try {
                // Ensure both isha and fajr are valid moment objects
                if (!moment.isMoment(isha) || !moment.isMoment(fajr)) {
                    console.error('Invalid input for Tahajjud calculation');
                    return null;
                }

                // If fajr is before isha, add a day to fajr
                let fajrTime = moment(fajr);
                if (fajrTime.isBefore(isha)) {
                    fajrTime.add(1, 'day');
                }

                // Calculate last third of the night
                const nightDuration = moment.duration(fajrTime.diff(isha));
                const lastThirdStart = moment(isha).add(nightDuration.asMinutes() * 2 / 3, 'minutes');
                
                return lastThirdStart;
            } catch (error) {
                console.error('Error calculating Tahajjud time:', error);
                return null;
            }
        }

        function calculateSuhoorTime(fajr) {
            try {
                // Ensure fajr is a valid moment object
                if (!moment.isMoment(fajr)) {
                    console.error('Invalid input for Suhoor calculation');
                    return null;
                }

                // Suhoor ends 10 minutes before Fajr
                return moment(fajr).subtract(10, 'minutes');
            } catch (error) {
                console.error('Error calculating Suhoor time:', error);
                return null;
            }
        }

        function calculateIshraqTime(sunrise) {
            try {
                // Ensure sunrise is a valid moment object
                if (!moment.isMoment(sunrise)) {
                    console.error('Invalid input for Ishraq calculation');
                    return null;
                }

                // Ishraq starts 20 minutes after sunrise
                return moment(sunrise).add(20, 'minutes');
            } catch (error) {
                console.error('Error calculating Ishraq time:', error);
                return null;
            }
        }

        function updatePrayerTimesUI(times) {
            // Update all prayer times in UI
            const prayers = ['tahajjud', 'suhoor', 'fajr', 'ishraq', 'dhuhr', 'asr', 'maghrib', 'isha'];
            
            prayers.forEach(prayer => {
                const timeElement = document.getElementById(`${prayer}Time`);
                if (timeElement && times[prayer]) {
                    timeElement.textContent = times[prayer].format('h:mm A');
                    
                    // Update countdown if it exists
                    const countdownElement = document.getElementById(`${prayer}Countdown`);
                    if (countdownElement) {
                        const now = moment();
                        if (times[prayer].isAfter(now)) {
                            const duration = moment.duration(times[prayer].diff(now));
                            const hours = Math.floor(duration.asHours());
                            const minutes = duration.minutes();
                            countdownElement.textContent = `Next in ${hours}h ${minutes}m`;
                        } else {
                            countdownElement.textContent = '';
                        }
                    }
                }
            });
        }

        // Initialize
        getLocation();
        initializeCalculationMethod();
        initializeQariSelector();
        setInterval(updateCurrentTime, 1000);
        setInterval(getMoonPhase, 60000);
        setInterval(getIslamicDate, 60000);
        setInterval(updateCountdowns, 1000);
        updateCurrentTime();
        getMoonPhase();
        getIslamicDate();
    </script>
</body>
</html>